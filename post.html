<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Post</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 2em; max-width: 600px; }
  a { color: #007bff; text-decoration: none; }
  a:hover { text-decoration: underline; }

  /* Add comment box styling (copied from index.html) */
  .post-card {
    background: #e3f2fd;
    border-radius: 12px;
    padding: 0.6em 0.75em;
    margin-bottom: 1.5em;
    display: flex;
    gap: 0.6em;
    align-items: stretch;
    justify-content: space-between;
    min-height: 56px;
    box-sizing: border-box;
  }

  .post-card textarea {
    flex: 1;
    min-height: 44px;
    height: 100%;
    background: transparent;
    border: none;
    outline: none;
    resize: none;
    padding: 0;
    margin: 0;
    line-height: 1.4;
    font-family: inherit;
    font-size: 1rem;
    color: #111;
    overflow: auto;
  }

  .post-card button {
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    background: none;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.12s ease;
  }

  .post-card button:hover {
    background: rgba(25,118,210,0.12);
  }

  .post-card button svg {
    width: 22px;
    height: 22px;
    fill: #1976d2;
  }

  /* Loading / spinning state for send button */
  .post-card button.loading svg {
    opacity: 0.6;
    filter: grayscale(1);
    animation: spin 0.6s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }
  
  /* Main post styling */
  .post-main {
    background: #e3f2fd;
    padding: 1em;
    margin: 1em 0;
    border-radius: 10px;
    cursor: default;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }
  .post-main .post-header { font-size: 1.2em; margin-bottom: 0.5em; }
  .post-main .post-header a { font-size: 1em; margin-left: 0.5em; font-weight: normal; }
  .post-main .post-message { font-size: 1.1em; margin-bottom: 0.5em; }

  /* Comment styling */
  .comment { background: #f5f5f5; padding: 0.6em; margin: 0.5em 0; border-radius: 6px; cursor: default; }
  .comment .post-header { font-size: 1.1em; margin-bottom: 0.3em; }
  .comment .post-header a { font-size: 0.95em; margin-left: 0.3em; font-weight: normal; }
  small { color: gray; font-size: 0.85em; }
  input { width: 100%; padding: 0.6em; margin: 0.5em 0; border-radius: 6px; border: 1px solid #ccc; }

  /* Hover highlight */
  .post:hover, .message:hover, .user:hover, .comment:hover { background: #e3f2fd !important; transition: background 0.2s ease; }

  .like-btn {
    flex-shrink: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    margin-left: 8px;
    background: none;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.12s ease, transform 0.3s ease;
  }
  .like-btn:hover { background: rgba(25,118,210,0.12); }
  .like-btn svg { width: 20px; height: 20px; fill: #1976d2; transition: opacity 0.3s ease, transform 0.6s ease; }
  .like-btn.loading svg { opacity: 0.6; filter: grayscale(1); animation: spin 0.6s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

  /* Tabs */
  .tabs { display: flex; align-items: center; gap: 2em; margin: 1.2em 0 1em 0; font-size: 1.25em; }
  .tabs a { color: black; text-decoration: none; font-weight: normal; transition: font-weight 0.15s ease, color 0.15s ease; }
  .tabs a:hover { font-weight: bold; color: black; }
  .tabs a.active { font-weight: bold; color: black; cursor: default; }
</style>
</head>
<body>
<a id="backLink" href="#">‚Üê Back</a>
<script>
  const URLparams = new URLSearchParams(window.location.search);
  const from = URLparams.get("from") || "index.html";
  document.getElementById("backLink").href = from;
</script>

<div id="post"></div>
<!-- Comment Box -->
<div id="addCommentContainer"></div>

<div class="tabs">
  <a id="commentsTab" href="#" class="active">Comments</a>
  <a id="likesTab" href="#">Likes</a>
</div>

<input type="text" id="searchComments" placeholder="Search comments..." oninput="filterComments()">
<div id="comments"></div>

<script>
const API_URL = "https://gentle-wind-dea4.silly-7f7.workers.dev";
const urlParams = new URLSearchParams(window.location.search);
const postId = urlParams.get("id");
let allComments = [];

function unlikedHeartSVG() {
  return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="22" height="22">
    <path fill="none" stroke="#1976d2" stroke-width="2" d="M12 21s-7.5-4.65-10-9.5C.4 6.44 2.6 3 6.2 3c1.9 0 3.5 1.1 4.3 2.7C11.3 4.1 12.9 3 14.8 3c3.6 0 5.8 3.44 4.2 8.5C19.5 16.35 12 21 12 21z"/>
  </svg>`;
}

function likedHeartSVG() {
  return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="22" height="22">
    <path fill="#1976d2" d="M12 21s-7.5-4.65-10-9.5C.4 6.44 2.6 3 6.2 3c1.9 0 3.5 1.1 4.3 2.7C11.3 4.1 12.9 3 14.8 3c3.6 0 5.8 3.44 4.2 8.5C19.5 16.35 12 21 12 21z"/>
  </svg>`;
}

function parseBackendDate(dateStr) {
  if (!dateStr) return "Invalid date";

  // If it's already a Date object
  if (dateStr instanceof Date) return dateStr.toLocaleString("en-GB", {
    hour12: true,
  });

  // Try native parsing first
  const tryNative = new Date(dateStr);
  if (!isNaN(tryNative)) {
    return tryNative.toLocaleString("en-GB", { hour12: true });
  }

  // Manual parse for DD/MM/YYYY HH:mm:ss
  const parts = dateStr.split(" ");
  const datePart = parts[0] || "";
  const timePart = parts[1] || "00:00:00";
  const [d, m, y] = datePart.split(/[\/\-]/).map(Number);
  if (!d || !m || !y) return "Invalid date";

  const parsed = new Date(
    `${y}-${String(m).padStart(2, "0")}-${String(d).padStart(2, "0")}T${timePart}`
  );
  if (isNaN(parsed)) return "Invalid date";

  return parsed.toLocaleString("en-GB", { hour12: true });
}

async function loadPost() {
  if (!postId) { document.body.innerHTML = "<p>Post ID not provided.</p>"; return; }

  const res = await fetch(`${API_URL}?type=post&id=${postId}`);
  const data = await res.json();

  if (!data || data.error) { document.body.innerHTML = "<p>Post not found.</p>"; return; }

  const p = data.post;
  allComments = data.comments || [];

  // Update tab URLs
  document.getElementById("commentsTab").href = `post.html?id=${postId}`;
  document.getElementById("likesTab").href = `likes.html?id=${postId}`;

  // Add counts into tab labels
  const commentCount = allComments.length;
  const likesRes = await fetch(`${API_URL}?likesForPost=${postId}`);
  const likesData = await likesRes.json();
  const likeCount = likesData.likes ? likesData.likes.length : 0;

  document.getElementById("commentsTab").textContent = `${commentCount} Comments`;
  document.getElementById("likesTab").textContent = `${likeCount} Likes`;

  // Check if current user liked the post
  const currentUser = JSON.parse(localStorage.getItem("user") || "null");
  let isLiked = false;
  if (currentUser && currentUser.username) {
    try {
      const userLikesRes = await fetch(`${API_URL}?likesFor=${encodeURIComponent(currentUser.username)}`);
      const userLikesData = await userLikesRes.json();
      const likedPosts = userLikesData.likedPosts || [];
      isLiked = likedPosts.includes(p.id);
    } catch (err) { console.warn("Could not load liked posts:", err); }
  }

  // Render main post with like button
  const postDiv = document.getElementById("post");
  postDiv.innerHTML = `
    <div class="post-main">
      <div style="flex:1">
        <div class="post-header">
          <strong>${p.name || "Unknown User"}</strong>
          <a href="user.html?id=${p.userId}&from=post.html" style="margin-left: 0.3em;">@${p.username}</a>
        </div>
        <div class="post-message">${p.message}</div>
        <small>${parseBackendDate(p.timestamp)}</small>
      </div>
      <button class="like-btn" title="Like" data-postid="${p.id}">
        ${isLiked ? likedHeartSVG() : unlikedHeartSVG()}
      </button>
    </div>
  `;

  setupCommentBox(postId);

  const likeButton = postDiv.querySelector(".like-btn");
  const SECRET_KEY = "alva-the-fortnite-god";

  likeButton.addEventListener("click", async e => {
    e.preventDefault(); e.stopPropagation();
    if (!currentUser || !currentUser.username) { alert("You need to be logged in to like posts."); return; }
    likeButton.classList.add("loading");
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ key: SECRET_KEY, action: "like", postId: p.id, username: currentUser.username })
      });
      const result = await res.json();
      likeButton.classList.remove("loading");
      if (result.success) {
        likeButton.innerHTML = result.liked ? likedHeartSVG() : unlikedHeartSVG();
      } else alert(result.error || "Failed to like post");
    } catch (err) {
      likeButton.classList.remove("loading");
      alert("Failed to like post: " + err.message);
    }
  });

  renderComments(allComments);
}

function renderComments(comments) {
  const commentsDiv = document.getElementById("comments");
  if (!comments || comments.length === 0) { commentsDiv.innerHTML = "<em>No comments yet.</em>"; return; }

  commentsDiv.innerHTML = comments.map(cm => `
    <div class="comment">
      <div class="post-header">
        <strong>${cm.name || "Unknown User"}</strong>
        <a href="user.html?id=${cm.userId}&from=post.html" style="margin-left: 0.3em;">@${cm.username}</a>
      </div>
      <div class="post-message">${cm.comment}</div>
      <small>${parseBackendDate(cm.timestamp)}</small>
    </div>
  `).join("");
}

function setupCommentBox(postId) {
  const container = document.getElementById("addCommentContainer");
  const user = JSON.parse(localStorage.getItem("user") || "null");

  if (!user || !user.username) {
    container.innerHTML = `
      <div class="post-card" style="text-align:center;">
        <div style="width:100%;">
          <p>You need to be logged in to comment.</p>
          <p>
            <a href="login.html">Login</a> or
            <a href="create.html">Create an Account</a>
          </p>
        </div>
      </div>
    `;
    return;
  }

  container.innerHTML = `
    <form id="commentForm" class="post-card">
      <textarea id="commentMessage" placeholder="Write a comment..." required></textarea>
      <button type="submit" title="Comment">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M12 0a12 12 0 1 0 12 12A12 12 0 0 0 12 0Zm4.91 10.41A1 1 0 0 1 16 11h-2.25a.25.25 0 0 0-.25.25v7.25a1.5 1.5 0 0 1-3 0v-7.25a.25.25 0 0 0-.25-.25H8a1 1 0 0 1-.75-1.66l4-4.5a1 1 0 0 1 1.5 0l4 4.5a1 1 0 0 1 .16 1.07Z"></path>
        </svg>
      </button>
    </form>
  `;

  const form = document.getElementById("commentForm");
  const button = form.querySelector("button");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const message = document.getElementById("commentMessage").value.trim();
    if (!message) return alert("Please enter a comment.");

    button.disabled = true;
    button.classList.add("loading");

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          key: "alva-the-fortnite-god",
          action: "comment",
          postId,
          username: user.username,
          message,
        }),
      });

      const result = await res.json();
      if (result.success) {
        form.reset();
        loadPost(); // reload comments instantly
      } else {
        alert(result.error || "Failed to add comment");
      }
    } catch (err) {
      alert("Failed to add comment: " + err.message);
    } finally {
      button.disabled = false;
      button.classList.remove("loading");
    }
  });
}

function filterComments() {
  const term = document.getElementById("searchComments").value.toLowerCase();
  const filtered = allComments.filter(cm =>
    (cm.username || "").toLowerCase().includes(term) ||
    (cm.name || "").toLowerCase().includes(term) ||
    (cm.comment || "").toLowerCase().includes(term)
  );
  renderComments(filtered);
}

loadPost();
</script>
</body>
</html>
